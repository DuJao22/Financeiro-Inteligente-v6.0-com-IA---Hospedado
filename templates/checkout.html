{% extends "base.html" %}

{% block title %}Checkout - {{ plan_name }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header text-center">
                <h1 class="card-title">
                    <i class="fas fa-credit-card"></i> Checkout
                </h1>
                <p class="card-subtitle">Finalize sua assinatura do plano {{ plan_name }}</p>
            </div>
            
            <div class="card-body">
                <!-- Resumo do Plano -->
                <div class="alert alert-light border">
                    <h5><i class="fas fa-package"></i> Resumo da Compra</h5>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Plano:</strong> {{ plan_name|title }}
                        </div>
                        <div class="col-6 text-end">
                            <strong>R$ {{ "%.2f"|format(price) }}</strong>/mês
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <small class="text-muted">Cobrança recorrente mensal • Cancele quando quiser</small>
                        </div>
                    </div>
                </div>

                <!-- Formulário de Pagamento -->
                <form id="payment-form" method="POST">
                    <input type="hidden" name="plan" value="{{ plan }}">
                    <input type="hidden" name="price" value="{{ price }}">
                    
                    <div class="mb-4">
                        <h6><i class="fas fa-credit-card"></i> Método de Pagamento</h6>
                        
                        <!-- Mercado Pago Integration -->
                        <div class="payment-methods">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="payment_method" id="credit_card" value="credit_card" checked>
                                <label class="form-check-label" for="credit_card">
                                    <i class="fab fa-cc-visa"></i>
                                    <i class="fab fa-cc-mastercard"></i>
                                    <i class="fab fa-cc-amex"></i>
                                    Cartão de Crédito
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="payment_method" id="pix" value="pix">
                                <label class="form-check-label" for="pix">
                                    <i class="fas fa-qrcode"></i> PIX
                                    <small class="text-success d-block">Aprovação instantânea</small>
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="payment_method" id="boleto" value="boleto">
                                <label class="form-check-label" for="boleto">
                                    <i class="fas fa-barcode"></i> Boleto Bancário
                                    <small class="text-warning d-block">Aprovação em até 2 dias úteis</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Token do Mercado Pago -->
                    {% if mp_token_configured %}
                    <div class="mb-4">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> Mercado Pago Configurado</h6>
                            <p class="mb-0">✅ Token do Mercado Pago já está configurado no sistema!</p>
                            <small class="text-success">Seus pagamentos serão processados automaticamente.</small>
                        </div>
                        <!-- Hidden field to maintain compatibility -->
                        <input type="hidden" name="mp_token" value="">
                    </div>
                    {% else %}
                    <div class="mb-4">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-key"></i> Configuração do Mercado Pago</h6>
                            <p class="mb-2">Para processar pagamentos reais, configure seu token do Mercado Pago:</p>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input type="password" class="form-control" placeholder="Token do Mercado Pago" name="mp_token" id="mp_token">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleToken()">
                                    <i class="fas fa-eye" id="toggleIcon"></i>
                                </button>
                            </div>
                            <small class="text-muted">
                                <strong>Para produção:</strong> Configure a variável de ambiente <code>MP_ACCESS_TOKEN</code><br>
                                <strong>Para teste:</strong> Insira o token aqui temporariamente<br>
                                <a href="https://www.mercadopago.com.br/developers/pt/docs/checkout-pro/additional-content/your-integrations/credentials" target="_blank">
                                    Obter seu token <i class="fas fa-external-link-alt"></i>
                                </a>
                            </small>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Dados do Cliente -->
                    <div class="mb-4">
                        <h6><i class="fas fa-user"></i> Dados do Cliente</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customer_name" class="form-label">Nome Completo</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" value="{{ session.user_name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customer_email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="customer_email" name="customer_email" value="{{ session.user_email }}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customer_phone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone" placeholder="(11) 99999-9999">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customer_document" class="form-label">CPF/CNPJ</label>
                                <input type="text" class="form-control" id="customer_document" name="customer_document" placeholder="000.000.000-00">
                            </div>
                        </div>
                    </div>

                    <!-- Termos e Condições -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="accept_terms" name="accept_terms" required>
                            <label class="form-check-label" for="accept_terms">
                                Aceito os <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">termos de uso</a> e 
                                <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">política de privacidade</a>
                            </label>
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="row">
                        <div class="col-6">
                            <a href="{{ url_for('assinatura') }}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                        </div>
                        <div class="col-6">
                            <button type="submit" class="btn btn-success w-100" id="submitBtn">
                                <i class="fas fa-lock"></i> Finalizar Pagamento
                                <br><small>R$ {{ "%.2f"|format(price) }}</small>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Informações de Segurança -->
        <div class="card mt-3">
            <div class="card-body text-center">
                <h6><i class="fas fa-shield-alt text-success"></i> Pagamento Seguro</h6>
                <p class="mb-0 text-muted">
                    <small>
                        Seus dados são protegidos com criptografia SSL 256-bits.
                        Processamento via Mercado Pago, líder em pagamentos na América Latina.
                    </small>
                </p>
                <div class="mt-2">
                    <img src="https://http2.mlstatic.com/frontend-assets/ui-navigation/5.21.22/mercadopago/logo__large_plus@2x.png" 
                         alt="Mercado Pago" style="height: 30px;" class="me-3">
                    <i class="fas fa-lock text-success"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Termos -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Termos de Uso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>1. Sobre o Serviço</h6>
                <p>Este é um sistema de gestão financeira que oferece diferentes planos de assinatura.</p>
                
                <h6>2. Planos e Cobrança</h6>
                <p>As cobranças são mensais e recorrentes. Você pode cancelar a qualquer momento.</p>
                
                <h6>3. Responsabilidades</h6>
                <p>O usuário é responsável pela veracidade dos dados informados.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Privacidade -->
<div class="modal fade" id="privacyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Política de Privacidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Coleta de Dados</h6>
                <p>Coletamos apenas os dados necessários para o funcionamento do serviço.</p>
                
                <h6>Uso dos Dados</h6>
                <p>Seus dados são utilizados exclusivamente para o funcionamento da plataforma.</p>
                
                <h6>Segurança</h6>
                <p>Implementamos medidas de segurança para proteger suas informações.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleToken() {
    const tokenInput = document.getElementById('mp_token');
    const toggleIcon = document.getElementById('toggleIcon');
    
    if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        tokenInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
    }
}

document.getElementById('payment-form').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
    submitBtn.disabled = true;
});

// Máscara para telefone
document.getElementById('customer_phone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
    value = value.replace(/(\d)(\d{4})$/, '$1-$2');
    e.target.value = value;
});

// Máscara para CPF
document.getElementById('customer_document').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length <= 11) {
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    } else {
        value = value.replace(/^(\d{2})(\d)/, '$1.$2');
        value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
    }
    e.target.value = value;
});
</script>
{% endblock %}