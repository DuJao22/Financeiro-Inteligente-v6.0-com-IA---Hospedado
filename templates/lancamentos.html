{% extends "base.html" %}

{% block title %}Lançamentos - SaaS Financeiro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-plus-circle"></i> Lançamentos</h1>
</div>

<div class="row">
    <!-- Form -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-plus"></i> Novo Lançamento
                </h3>
            </div>
            
            <form method="POST">
                <div class="form-group">
                    <label for="type" class="form-label">
                        <i class="fas fa-exchange-alt"></i> Tipo
                    </label>
                    <select class="form-control form-select" id="type" name="type" required>
                        <option value="">Selecione o tipo</option>
                        <option value="receita">
                            <i class="fas fa-arrow-up"></i> Receita
                        </option>
                        <option value="despesa">
                            <i class="fas fa-arrow-down"></i> Despesa
                        </option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="amount" class="form-label">
                        <i class="fas fa-dollar-sign"></i> Valor
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="amount" 
                           name="amount" 
                           required 
                           placeholder="0,00"
                           data-currency>
                </div>
                
                <div class="form-group">
                    <label for="account_id" class="form-label">
                        <i class="fas fa-university"></i> Conta
                    </label>
                    <select class="form-control form-select" id="account_id" name="account_id" required>
                        <option value="">Selecione a conta</option>
                        {% for account in accounts %}
                        <option value="{{ account.id }}">{{ account.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="category_id" class="form-label">
                        <i class="fas fa-tag"></i> Categoria
                    </label>
                    <select class="form-control form-select" id="category_id" name="category_id">
                        <option value="">Selecione a categoria</option>
                        <optgroup label="Receitas">
                            {% for category in categories %}
                                {% if category.type == 'receita' %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                        <optgroup label="Despesas">
                            {% for category in categories %}
                                {% if category.type == 'despesa' %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="when" class="form-label">
                        <i class="fas fa-calendar"></i> Data e Hora
                    </label>
                    <input type="datetime-local" 
                           class="form-control" 
                           id="when" 
                           name="when" 
                           required>
                </div>
                
                <div class="form-group">
                    <label for="note" class="form-label">
                        <i class="fas fa-sticky-note"></i> Descrição
                    </label>
                    <textarea class="form-control" 
                              id="note" 
                              name="note" 
                              rows="3" 
                              placeholder="Descrição opcional"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-save"></i> Salvar Lançamento
                </button>
            </form>
        </div>
    </div>
    
    <!-- List -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-list"></i> Histórico de Lançamentos
                </h3>
            </div>
            
            {% if entries %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Conta</th>
                                <th>Categoria</th>
                                <th>Descrição</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in entries %}
                            <tr>
                                <td>{{ br_datetime(entry.when_utc) }}</td>
                                <td>
                                    {% if entry.type == 'receita' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-arrow-up"></i> Receita
                                        </span>
                                    {% elif entry.type == 'despesa' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-arrow-down"></i> Despesa
                                        </span>
                                    {% else %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-exchange-alt"></i> Transferência
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="currency {% if entry.type == 'receita' %}positive{% else %}negative{% endif %}">
                                        {{ brl(entry.amount) }}
                                    </span>
                                </td>
                                <td>{{ entry.account_name }}</td>
                                <td>{{ entry.category_name or '-' }}</td>
                                <td>
                                    {% if entry.note %}
                                        <span title="{{ entry.note }}">
                                            {{ entry.note[:30] }}{% if entry.note|length > 30 %}...{% endif %}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-receipt fa-3x text-muted"></i>
                    <h4 class="text-muted mt-3">Nenhum lançamento ainda</h4>
                    <p class="text-muted">Comece criando seu primeiro lançamento usando o formulário ao lado.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if not accounts %}
<div class="alert alert-warning mt-4">
    <i class="fas fa-exclamation-triangle"></i>
    <strong>Atenção:</strong> Você precisa ter pelo menos uma conta para criar lançamentos.
    <button class="btn btn-warning btn-sm ms-2" onclick="createDefaultAccount()">
        <i class="fas fa-plus"></i> Criar Conta Principal
    </button>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Set default datetime to now
document.addEventListener('DOMContentLoaded', function() {
    const whenInput = document.getElementById('when');
    if (whenInput && !whenInput.value) {
        const now = new Date();
        
        // Format to YYYY-MM-DDTHH:MM
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        whenInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
});

// Update category options based on transaction type
document.getElementById('type').addEventListener('change', function() {
    const categorySelect = document.getElementById('category_id');
    const optgroups = categorySelect.querySelectorAll('optgroup');
    
    // Show all optgroups first
    optgroups.forEach(group => group.style.display = 'block');
    
    if (this.value === 'receita') {
        // Hide expense categories
        optgroups.forEach(group => {
            if (group.label === 'Despesas') {
                group.style.display = 'none';
            }
        });
    } else if (this.value === 'despesa') {
        // Hide income categories
        optgroups.forEach(group => {
            if (group.label === 'Receitas') {
                group.style.display = 'none';
            }
        });
    }
    
    // Reset category selection
    categorySelect.value = '';
});

// Create default account function
function createDefaultAccount() {
    // This would need to be implemented as a separate endpoint
    // For now, just show a message
    alert('Funcionalidade em desenvolvimento. Por favor, entre em contato com o suporte.');
}
</script>
{% endblock %}
